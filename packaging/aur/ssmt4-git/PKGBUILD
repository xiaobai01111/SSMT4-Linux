pkgname=ssmt4-git
pkgver=0.1.0.r0.g0000000
pkgrel=1
pkgdesc="Super Simple Migoto Tools 4th (Tauri launcher for Linux)"
arch=("x86_64")
url="https://github.com/StarBobis/SSMT4"
license=("GPL3")
depends=(
  "gtk3"
  "webkit2gtk-4.1"
  "libsoup3"
  "xdg-utils"
)
optdepends=(
  "xorg-xwayland: X11 compatibility in Wayland sessions (Wine/Proton workflows)"
  "wine: launch Windows game executables and helper tools"
  "winetricks: install Wine runtime components from the launcher"
  "vulkan-icd-loader: Vulkan loader for DXVK/VKD3D workflows"
  "libayatana-appindicator: tray indicator compatibility on some desktop environments"
)
makedepends=(
  "git"
  "cargo"
  "rust"
  "nodejs"
  "npm"
)
provides=("ssmt4")
conflicts=("ssmt4" "ssmt4-bin")
source=("${pkgname}::git+${url}.git")
sha256sums=("SKIP")

pkgver() {
  cd "${srcdir}/${pkgname}"
  local base_ver
  base_ver="$(sed -n 's/.*"version":[[:space:]]*"\([^"]*\)".*/\1/p' package.json | head -n1)"
  printf "%s.r%s.g%s" \
    "${base_ver:-0.0.0}" \
    "$(git rev-list --count HEAD)" \
    "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}/${pkgname}"
  npm ci --no-audit --no-fund
}

build() {
  cd "${srcdir}/${pkgname}"
  npm run build
  cargo build --release --manifest-path src-tauri/Cargo.toml --locked
}

package() {
  cd "${srcdir}/${pkgname}"

  install -Dm755 \
    "src-tauri/target/release/ssmt4" \
    "${pkgdir}/usr/bin/ssmt4"

  install -Dm644 \
    "src-tauri/icons/128x128.png" \
    "${pkgdir}/usr/share/icons/hicolor/128x128/apps/ssmt4.png"

  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  install -Dm644 /dev/stdin "${pkgdir}/usr/share/applications/ssmt4.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=SSMT4
Comment=Super Simple Migoto Tools 4th
Exec=ssmt4
Icon=ssmt4
Terminal=false
Categories=Game;Utility;
StartupNotify=true
EOF
}
